# References
https://wiki.onosproject.org/display/ONOS/SONA+User+Guide
https://github.com/sonaproject

# Prerequisite
2 Baremetal nodes (one is for  All-in-One node that has Control/Compute and SONA in one server) and the other is for a Gateway)

OS: Ubuntu 16.04 (For Openstack node)

all interfaces on nodes should be set to MTU 1600Byte. If you don't have right to configure switch, then set MTU 1500 to node interfaces and set MTU 1400 to VM interface.

Note that, OVSDB port is basically 6640, but in all-in-one installation case we use 6650 as the OVSDB port so that ONOS and Openstack Compute node can run at the same node.

```
# sudo ovs-vsctl set-manager ptcp:6650
```

# Openstack/SONA install

Update and install dependencies
```
# apt-get update
# apt-get install -y git
```

Nameserver configuration
```
~# cat /etc/resolv.conf
# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
nameserver 8.8.8.8
```

Clone source
```
# cd ~/
# git clone -b stable/queens https://git.openstack.org/openstack-dev/devstack
```

Create user and grant ownership
```
# ~/devstack/tools/create-stack-user.sh
# cp -R ~/devstack/ /opt/stack
# chown -R stack:stack /opt/stack
```

Switch to Stack User
```
# su - stack
$ cd ~/devstack
```

Creates local.conf at ~/devstack folder. You should change HOST_IP, SERVICE_HOST, RABBIT_HOST, DATABASE_HOST, Q_HOST to your IP address.
Note that networking-onos plug-in automatically installs ONOS and activates SONA application

```
[[local|localrc]]
HOST_IP=172.16.101.13
SERVICE_HOST=172.16.101.13
RABBIT_HOST=172.16.101.13
DATABASE_HOST=172.16.101.13
Q_HOST=172.16.101.13
  
ADMIN_PASSWORD=nova
DATABASE_PASSWORD=$ADMIN_PASSWORD
RABBIT_PASSWORD=$ADMIN_PASSWORD
SERVICE_PASSWORD=$ADMIN_PASSWORD
SERVICE_TOKEN=$ADMIN_PASSWORD
  
DATABASE_TYPE=mysql
  
# Log
USE_SCREEN=True
SCREEN_LOGDIR=/opt/stack/logs/screen
LOGFILE=/opt/stack/logs/xstack.sh.log
LOGDAYS=1
# Images
FORCE_CONFIG_DRIVE=True
  
# Networks
Q_ML2_TENANT_NETWORK_TYPE=vxlan
Q_ML2_PLUGIN_MECHANISM_DRIVERS=onos_ml2
Q_ML2_PLUGIN_TYPE_DRIVERS=flat,vlan,vxlan
ML2_L3_PLUGIN=onos_router
NEUTRON_CREATE_INITIAL_NETWORKS=False
enable_plugin networking-onos https://github.com/openstack/networking-onos.git stable/queens
ONOS_MODE=allinone
  
# Services
ENABLED_SERVICES=n-cpu,placement-client,neutron,key,nova,n-api,n-cond,n-sch,n-novnc,n-cauth,placement-api,g-api,g-reg,q-svc,horizon,rabbit,mysql
  
  
NOVA_VNC_ENABLED=True
VNCSERVER_PROXYCLIENT_ADDRESS=$HOST_IP
VNCSERVER_LISTEN=$HOST_IP
  
LIBVIRT_TYPE=kvm
  
# Branches
GLANCE_BRANCH=stable/queens
HORIZON_BRANCH=stable/queens
KEYSTONE_BRANCH=stable/queens
NEUTRON_BRANCH=stable/queens
NOVA_BRANCH=stable/queens
```

Install OpenStack with SONA through devstack
```
$ cd ~/devstack
$ ./stack.sh
```

After installation please connect to horizon dashboard by (172.16.101.13) to see openstack haveinstalled well.
Also connect to ONOS CLI,

```
# ssh -p 8101 karaf@172.16.101.13
Password authentication
Password: karaf
Welcome to Open Network Operating System (ONOS)!
     ____  _  ______  ____    
    / __ \/ |/ / __ \/ __/  
   / /_/ /    / /_/ /\ \    
   \____/_/|_/\____/___/    
                                
Documentation: wiki.onosproject.org     
Tutorials:     tutorials.onosproject.org
Mailing lists: lists.onosproject.org    
 
Come help out! Find out how at: contribute.onosproject.org
 
Hit '<tab>' for a list of available commands
and '[cmd] --help' for help on a specific command.
Hit '<ctrl-d>' or type 'system:shutdown' or 'logout' to shutdown ONOS.
 
onos> apps -s -a
*  24 org.onosproject.ovsdb-base           1.13.1   OVSDB Provider
*  25 org.onosproject.drivers.ovsdb        1.13.1   Generic OVSDB Drivers
*  52 org.onosproject.optical-model        1.13.1   Optical Network Model
*  53 org.onosproject.openflow-base        1.13.1   OpenFlow Base Provider
*  78 org.onosproject.drivers              1.13.1   Default Drivers
* 155 org.onosproject.openstacknode        1.13.1   OpenStack Node Bootstrap
* 161 org.onosproject.openstacknetworking  1.13.1   OpenStack Networking Application
 
onos> openstack-nodes
Hostname            Type           Integration Bridge      Management IP           Data IP             VLAN Intf           Uplink Port    State
compute-01          COMPUTE        of:00000000000000a1     172.16.101.13            172.16.101.13                                           INIT
controller          CONTROLLER     null                    172.16.101.13                                                                   COMPLETE
Total 2 nodes
 
onos> openstack-node-init -a
Initializing controller
Initializing compute-01
Done.
 
onos> openstack-nodes
Hostname            Type           Integration Bridge      Management IP           Data IP             VLAN Intf           Uplink Port    State
compute-01          COMPUTE        of:00000000000000a1     172.16.101.13            172.16.101.13                                           COMPLETE
controller          CONTROLLER     null                    172.16.101.13                                                                   COMPLETE
Total 2 nodes
onos>
```

Also check bridge is implemented well.
```
stack@vm2-flat:~/devstack$ sudo ovs-vsctl show
f196acba-9ab2-40fa-b1d4-8cd8b91b29fe
    Manager "ptcp:6650"
        is_connected: true
    Bridge br-int
        Controller "tcp:172.17.0.1:6653"
            is_connected: true
        fail_mode: secure
        Port vxlan
            Interface vxlan
                type: vxlan
                options: {key=flow, remote_ip=flow}
        Port br-int
            Interface br-int
    ovs_version: "2.8.1"
```
